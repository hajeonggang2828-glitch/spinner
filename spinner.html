<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>돌림판 웹앱</title>
  <!-- Tailwind CSS CDN을 로드하여 스타일을 적용합니다. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React, ReactDOM, Babel을 CDN에서 로드하여 React 코드를 브라우저에서 실행할 수 있도록 합니다. -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* 휠 회전 애니메이션에 사용될 transition을 정의합니다. */
    .wheel {
      transition: transform 4s cubic-bezier(0.12, 0.65, 0.12, 1);
    }
  </style>
</head>
<body class="font-sans">
  <div id="root"></div>

  <!-- type="text/babel"을 사용하여 이 스크립트 블록 내의 코드를 JSX로 처리합니다. -->
  <script type="text/babel">
    const { useState, useRef, useMemo, useEffect } = React;
    const { createRoot } = ReactDOM;

    // 설정 아이콘을 위한 SVG
    const SettingsIcon = (props) => (
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        {...props}
      >
        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.44a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.73v.56a2 2 0 0 1-1 1.73l-.15.08a2 2 0 0 0-.73 2.73l.78 1.44a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.44a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.73v-.56a2 2 0 0 1 1-1.73l.15-.08a2 2 0 0 0 .73-2.73l-.78-1.44a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
        <circle cx="12" cy="12" r="3" />
      </svg>
    );

    /**
     * 메인 돌림판 애플리케이션 컴포넌트입니다.
     * 사용자 정의 항목, 공정/지정 모드, 회전 기능 등을 관리합니다.
     */
    function App() {
      const [labels, setLabels] = useState(['A', 'B', 'C', 'D']);
      const [newLabel, setNewLabel] = useState('');
      const [mode, setMode] = useState('fair');
      const [forcedIndices, setForcedIndices] = useState([0, 0]); // 여러 결과를 지정하기 위해 배열로 변경
      const [isSpinning, setIsSpinning] = useState(false);
      const [rotation, setRotation] = useState(0);
      const [resultIndex, setResultIndex] = useState(null);
      const [logs, setLogs] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const forcedIndexQueue = useRef([]);

      const wheelRef = useRef(null);
      const resultRef = useRef(null);
      
      // mode가 fair로 변경될 때 큐를 초기화합니다.
      useEffect(() => {
        if (mode === 'fair') {
          forcedIndexQueue.current = [];
        }
      }, [mode]);

      const addLog = (line) => {
        setLogs((prev) => [`${new Date().toLocaleString()} — ${line}`, ...prev].slice(0, 50));
      };

      const addLabel = () => {
        const trimmed = newLabel.trim();
        if (!trimmed) return;
        setLabels((prev) => [...prev, trimmed]);
        setNewLabel('');
      };

      const removeLabel = (idx) => {
        setLabels((prev) => {
          const newLabels = prev.filter((_, i) => i !== idx);
          if (forcedIndices[0] >= newLabels.length) setForcedIndices([0, 0]);
          return newLabels;
        });
      };

      const handleForcedIndexChange = (index, value) => {
        const newForcedIndices = [...forcedIndices];
        newForcedIndices[index] = Number(value);
        setForcedIndices(newForcedIndices);
      };

      const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

      const spin = () => {
        if (labels.length < 2 || isSpinning) return;
        
        setIsSpinning(true);
        setResultIndex(null);
        
        let targetIndex;
        if (mode === 'stage') {
          // 큐가 비어 있으면 미리 설정된 값으로 채웁니다.
          if (forcedIndexQueue.current.length === 0) {
            forcedIndexQueue.current = [...forcedIndices];
          }
          // 큐에서 다음 결과를 가져옵니다.
          targetIndex = forcedIndexQueue.current.shift();
          
          // 큐가 비어 있으면 자동으로 공정 모드로 전환하지만 로그는 남기지 않습니다.
          if (forcedIndexQueue.current.length === 0) {
            setMode('fair');
          }
        } else {
          targetIndex = randomInt(0, labels.length - 1);
        }

        const fullSpins = randomInt(4, 7);
        const sliceAngle = 360 / labels.length;
        const targetCenter = targetIndex * sliceAngle + sliceAngle / 2;
        const jitter = (Math.random() - 0.5) * (sliceAngle * 0.3);
        const currentRotation = rotation % 360;
        const desiredEnd = 360 - (targetCenter + jitter);
        let delta = desiredEnd - currentRotation;
        if (delta < 0) delta += 360;
        const finalDelta = fullSpins * 360 + delta;
        
        setRotation((r) => r + finalDelta);

        // CSS transition duration은 style에서 설정
        const duration = 4000;

        setTimeout(() => {
          setIsSpinning(false);
          setResultIndex(targetIndex);
          addLog(`결과: "${labels[targetIndex]}"`);
        }, duration + 50);
      };

      const radius = 180;
      const center = 200;

      const segments = useMemo(() => {
        const sliceAngle = 360 / labels.length;
        return labels.map((label, i) => {
          const startAngle = (sliceAngle * i - 90) * (Math.PI / 180);
          const endAngle = (sliceAngle * (i + 1) - 90) * (Math.PI / 180);
          const x1 = center + radius * Math.cos(startAngle);
          const y1 = center + radius * Math.sin(startAngle);
          const x2 = center + radius * Math.cos(endAngle);
          const y2 = center + radius * Math.sin(endAngle);
          const largeArc = sliceAngle > 180 ? 1 : 0;
          const path = `M${center},${center} L${x1},${y1} A${radius},${radius} 0 ${largeArc},1 ${x2},${y2} Z`;
          const textAngle = sliceAngle * i + sliceAngle / 2;
          const textRadians = (textAngle - 90) * (Math.PI / 180);
          const textX = center + radius * 0.6 * Math.cos(textRadians);
          const textY = center + radius * 0.6 * Math.sin(textRadians);
          
          const fillColor = i % 2 === 0 ? '#c7d2fe' : '#e0e7ff';
          const textColor = '#1e3a8a';

          return (
            <g key={i}>
              <path d={path} fill={fillColor} stroke='white' strokeWidth={2} />
              <text
                x={textX}
                y={textY}
                textAnchor='middle'
                dominantBaseline='middle'
                fill={textColor}
                fontWeight='600'
                fontSize={14}
                transform={`rotate(${textAngle}, ${textX}, ${textY})`}
              >
                {label}
              </text>
            </g>
          );
        });
      }, [labels]);

      return (
        <div className='min-h-screen w-full bg-gradient-to-b from-indigo-50 to-white text-slate-800 p-4 md:p-8'>
          <header className='mx-auto max-w-5xl mb-6 md:mb-10 flex items-center justify-between'>
            <h1 className='text-2xl md:text-4xl font-bold tracking-tight'>
              돌림판 <span className='text-indigo-600'>웹앱</span>
            </h1>
            <button
              onClick={() => setShowSettings((s) => !s)}
              className='p-2 rounded-full hover:bg-indigo-100 transition-colors'
              aria-label='설정 열기'
            >
              <SettingsIcon className='w-6 h-6 text-indigo-600' />
            </button>
          </header>

          <main className='mx-auto max-w-5xl grid grid-cols-1 lg:grid-cols-5 gap-6 items-start'>
            <section className='lg:col-span-3 relative'>
              <div className='mx-auto h-[400px] w-[400px] md:h-[500px] md:w-[500px] relative flex justify-center items-center'>
                <div className='absolute top-0 left-1/2 -translate-x-1/2 translate-y-2 z-20'>
                  <svg width={40} height={40} viewBox='0 0 24 24'>
                    {/* 크기 및 위치가 조정된 화살표 SVG path */}
                    <path d='M12 22 L20 12 H15 V2 H9 V12 H4 Z' fill='#4f46e5' />
                  </svg>
                </div>

                {/* onClick 이벤트를 SVG에 직접 추가하여 휠을 클릭 가능하게 합니다. */}
                <svg
                  ref={wheelRef}
                  onClick={spin}
                  width={center * 2}
                  height={center * 2}
                  style={{ transform: `rotate(${rotation}deg)` }}
                  className={`block wheel ${!isSpinning && labels.length >= 2 ? 'cursor-pointer' : 'cursor-not-allowed opacity-50'}`}
                >
                  {segments}
                  <circle cx={center} cy={center} r={40} fill='white' stroke='#c7d2fe' strokeWidth={4} />
                  <text
                    x={center}
                    y={center}
                    textAnchor='middle'
                    dominantBaseline='middle'
                    fill='#475569'
                    fontWeight='600'
                    className='select-none'
                  >
                    {isSpinning ? '돌리는 중...' : '돌리기'}
                  </text>
                </svg>
              </div>

              {/* 별도의 버튼을 삭제했습니다. 휠 자체가 버튼 역할을 합니다. */}
              <div className='mt-4 text-center min-h-[2rem]'>
                {resultIndex !== null && (
                  <div
                    key={labels[resultIndex]}
                    ref={resultRef}
                    className='inline-flex items-center gap-2 rounded-2xl bg-indigo-50 px-6 py-3 text-indigo-700 font-bold border border-indigo-100 shadow-lg'
                  >
                    <span>결과:</span>
                    <span className='text-2xl md:text-3xl'>{labels[resultIndex]}</span>
                  </div>
                )}
              </div>
            </section>

            <aside className='lg:col-span-2'>
              <div className='rounded-2xl border bg-white shadow-sm p-4 md:p-5 space-y-5'>
                <div>
                  <div className='font-semibold mb-2'>항목</div>
                  <div className='flex gap-2'>
                    <input
                      value={newLabel}
                      onChange={(e) => setNewLabel(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && addLabel()}
                      placeholder='예: 피자, 치킨, 햄버거'
                      className='flex-1 rounded-xl border px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500'
                    />
                    <button
                      onClick={addLabel}
                      className='rounded-xl border px-3 py-2 bg-slate-50 hover:bg-slate-100 transition-colors'
                    >
                      추가
                    </button>
                  </div>
                  <ul className='mt-3 grid grid-cols-2 gap-2 max-h-60 overflow-y-auto'>
                    {labels.map((l, i) => (
                      <li key={i} className='flex items-center justify-between rounded-xl border px-3 py-2 bg-slate-50'>
                        <span className='truncate'>{i + 1}. {l}</span>
                        <button
                          onClick={() => removeLabel(i)}
                          className='text-slate-500 hover:text-red-600 transition-colors ml-2'
                          aria-label={`${l} 삭제`}
                        >
                          ✕
                        </button>
                      </li>
                    ))}
                  </ul>
                </div>

                {showSettings && (
                  <div className='border-t pt-4 space-y-4'>
                    <div>
                      <div className='font-semibold mb-2'>모드 선택</div>
                      <select
                        className='w-full rounded-xl border px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500'
                        value={mode}
                        onChange={(e) => setMode(e.target.value)}
                      >
                        <option value='fair'>공정 모드 (무작위)</option>
                        <option value='stage'>지정 모드 (다음 결과 선택)</option>
                      </select>
                    </div>

                    {mode === 'stage' && labels.length > 0 && (
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <div className='font-semibold mb-2'>다음 결과 선택</div>
                          <select
                            className='w-full rounded-xl border px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500'
                            value={forcedIndices[0]}
                            onChange={(e) => handleForcedIndexChange(0, e.target.value)}
                          >
                            {labels.map((l, i) => (
                              <option key={i} value={i}>{i + 1}. {l}</option>
                            ))}
                          </select>
                        </div>
                        <div>
                          <div className='font-semibold mb-2'>그 다음 결과 선택</div>
                          <select
                            className='w-full rounded-xl border px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500'
                            value={forcedIndices[1]}
                            onChange={(e) => handleForcedIndexChange(1, e.target.value)}
                          >
                            {labels.map((l, i) => (
                              <option key={i} value={i}>{i + 1}. {l}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                <div className='border-t pt-4'>
                  <div className='font-semibold mb-2'>활동 로그</div>
                  <div className='h-40 overflow-auto rounded-xl border bg-slate-50 p-2 text-xs leading-relaxed'>
                    {logs.length === 0 ? (
                      <div className='text-slate-400'>아직 로그가 없습니다.</div>
                    ) : (
                      <ul className='space-y-1'>
                        {logs.map((line, i) => (
                          <li key={i} className='whitespace-pre-wrap'>{line}</li>
                        ))}
                      </ul>
                    )}
                  </div>
                </div>
              </div>
            </aside>
          </main>
        </div>
      );
    }

    const rootElement = document.getElementById('root');
    const root = createRoot(rootElement);
    root.render(<App />);
  </script>
</body>
</html>
